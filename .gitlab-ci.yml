# Configuration GitLab CI pour OptiVolt (Version Robuste)

stages:
  - build
  - deploy
  - test
  - metrics
  - report

variables:
  DOTNET_VERSION: "8.0"
  TEST_DURATION: "30"

.ssh_template: &ssh_template
  before_script:
    - echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until
    - apt-get update -qq
    - apt-get install -y -qq openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

build:cli:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - echo "=== Structure du dépôt ==="
    - pwd
    - ls -la
    - echo "=== Build du projet ==="
    - cd OptiVoltCLI
    - dotnet restore ./OptiVoltCLI.csproj
    - dotnet publish ./OptiVoltCLI.csproj -c Release -o ../publish
    - cd ..
    - echo "=== Copie des ressources ==="
    - test -d scripts && cp -r scripts publish/ || mkdir -p publish/scripts
    - test -d config && cp -r config publish/ || mkdir -p publish/config
    - echo "=== Contenu final ==="
    - ls -laR publish/
  artifacts:
    paths:
      - publish/
    expire_in: 1 hour
  tags: [docker]


deploy:docker:
  stage: deploy
  image: mcr.microsoft.com/dotnet/sdk:8.0
  <<: *ssh_template
  script:
    - cd publish
    - rm -rf /root/optivolt-automation || true
    - ln -s "$CI_PROJECT_DIR/publish" /root/optivolt-automation
    - test -f /root/optivolt-automation/config/hosts.json && echo "Config OK" || (echo "Config missing" && ls -la config && exit 1)
    - dotnet OptiVoltCLI.dll deploy --environment docker
  dependencies:
    - build:cli
  only:
    - main
    - develop
  tags:
    - docker

deploy:microvm:
  stage: deploy
  image: mcr.microsoft.com/dotnet/sdk:8.0
  <<: *ssh_template
  script:
    - cd publish
    - dotnet OptiVoltCLI.dll deploy --environment microvm
  dependencies:
    - build:cli
  only:
    - main
  when: manual
  tags:
    - docker

deploy:unikernel:
  stage: deploy
  image: mcr.microsoft.com/dotnet/sdk:8.0
  <<: *ssh_template
  script:
    - cd publish
    - dotnet OptiVoltCLI.dll deploy --environment unikernel
  dependencies:
    - build:cli
  only:
    - main
  when: manual
  tags:
    - docker

test:cpu:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  <<: *ssh_template
  script:
    - cd publish
    - dotnet OptiVoltCLI.dll test --environment docker --type cpu
  dependencies:
    - build:cli
    - deploy:docker
  artifacts:
    paths:
      - results/
    expire_in: 1 week
  tags:
    - docker

test:api:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  <<: *ssh_template
  script:
    - cd publish
    - dotnet OptiVoltCLI.dll test --environment docker --type api
  dependencies:
    - build:cli
    - deploy:docker
  artifacts:
    paths:
      - results/
    expire_in: 1 week
  tags:
    - docker

test:db:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  <<: *ssh_template
  script:
    - cd publish
    - dotnet OptiVoltCLI.dll test --environment docker --type db
  dependencies:
    - build:cli
    - deploy:docker
  artifacts:
    paths:
      - results/
    expire_in: 1 week
  tags:
    - docker

metrics:collect:
  stage: metrics
  image: mcr.microsoft.com/dotnet/sdk:8.0
  # your ssh template stays here
  script:
    - apt-get update -qq || true
    - apt-get install -y -qq jq || true
    # Create the absolute path expected by the app and copy the config
    - mkdir -p /root/optivolt-automation/config
    - cp config/hosts.json /root/optivolt-automation/config/hosts.json
    # run CLI from publish
    - cd publish
    - dotnet OptiVoltCLI.dll metrics --environment docker || true
  dependencies:
    - build:cli
    - test:cpu
    - test:api
    - test:db
  artifacts:
    paths:
      - results/
    expire_in: 1 month
  tags: [docker]


report:generate:
  stage: report
  image: python:3.11-slim
  before_script:
    - echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until
    - apt-get update -qq
    - apt-get install -y -qq jq || true
    - pip3 install --quiet matplotlib pandas || true
  script:
    - test -f publish/scripts/generate_dashboard.py && python3 publish/scripts/generate_dashboard.py results || echo "Dashboard generation skipped"
  dependencies:
    - metrics:collect
    - build:cli
  artifacts:
    paths:
      - results/
    expire_in: 3 months
  only:
    - main
  tags:
    - docker