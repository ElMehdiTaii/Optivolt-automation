# Configuration GitLab CI pour OptiVolt (Version avec Fix Horloge)

stages:
  - build
  - deploy
  - test
  - metrics
  - report

variables:
  DOTNET_VERSION: "8.0"
  TEST_DURATION: "30"

# Template pour les jobs SSH (avec fix horloge)
.ssh_template: &ssh_template
  before_script:
    # Fix pour l'erreur d'horloge du runner
    - echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until
    - apt-get update -qq
    - apt-get install -y -qq openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

# Build du CLI
# Build du CLI (Version adaptée à la structure OptiVoltCLI/)
build:cli:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - pwd
    - ls -la
    # Publier le projet .NET
    - cd OptiVoltCLI
    - dotnet publish OptiVoltCLI/OptiVoltCLI.csproj --configuration Release --output ../publish
    - cd ..
    # Vérifier que publish existe
    - ls -la publish/
    # Copier scripts et config s'ils existent
    - |
      if [ -d "scripts" ]; then
        cp -r scripts publish/
        echo "✓ Scripts copiés"
      else
        echo "⚠ Pas de dossier scripts"
        mkdir -p publish/scripts
      fi
    - |
      if [ -d "config" ]; then
        cp -r config publish/
        echo "✓ Config copié"
      else
        echo "⚠ Pas de dossier config"
        mkdir -p publish/config
      fi
    # Afficher le résultat final
    - echo "=== Contenu final de publish ==="
    - ls -laR publish/
  artifacts:
    paths:
      - publish/
    expire_in: 1 hour
  tags:
    - docker

# Déploiement Docker
deploy:docker:
  stage: deploy
  image: mcr.microsoft.com/dotnet/sdk:8.0
  <<: *ssh_template
  script:
    - cd publish
    - dotnet OptiVoltCLI.dll deploy --environment docker
  dependencies:
    - build:cli
  only:
    - main
    - develop
  tags:
    - docker

# Déploiement MicroVM
deploy:microvm:
  stage: deploy
  image: mcr.microsoft.com/dotnet/sdk:8.0
  <<: *ssh_template
  script:
    - cd publish
    - dotnet OptiVoltCLI.dll deploy --environment microvm
  dependencies:
    - build:cli
  only:
    - main
  when: manual
  tags:
    - docker

# Déploiement Unikernel
deploy:unikernel:
  stage: deploy
  image: mcr.microsoft.com/dotnet/sdk:8.0
  <<: *ssh_template
  script:
    - cd publish
    - dotnet OptiVoltCLI.dll deploy --environment unikernel
  dependencies:
    - build:cli
  only:
    - main
  when: manual
  tags:
    - docker

# Tests CPU
test:cpu:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  <<: *ssh_template
  script:
    - cd publish
    - dotnet OptiVoltCLI.dll test --environment docker --type cpu
  dependencies:
    - build:cli
    - deploy:docker
  artifacts:
    paths:
      - results/
    expire_in: 1 week
  tags:
    - docker

# Tests API
test:api:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  <<: *ssh_template
  script:
    - cd publish
    - dotnet OptiVoltCLI.dll test --environment docker --type api
  dependencies:
    - build:cli
    - deploy:docker
  artifacts:
    paths:
      - results/
    expire_in: 1 week
  tags:
    - docker

# Tests Base de Données
test:db:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  <<: *ssh_template
  script:
    - cd publish
    - dotnet OptiVoltCLI.dll test --environment docker --type db
  dependencies:
    - build:cli
    - deploy:docker
  artifacts:
    paths:
      - results/
    expire_in: 1 week
  tags:
    - docker

# Collecte des métriques
metrics:collect:
  stage: metrics
  image: mcr.microsoft.com/dotnet/sdk:8.0
  <<: *ssh_template
  script:
    - apt-get install -y -qq jq
    - cd publish
    - dotnet OptiVoltCLI.dll metrics --environment docker
    - dotnet OptiVoltCLI.dll metrics --environment microvm || true
    - dotnet OptiVoltCLI.dll metrics --environment unikernel || true
  dependencies:
    - build:cli
    - test:cpu
    - test:api
    - test:db
  artifacts:
    paths:
      - results/
    expire_in: 1 month
  tags:
    - docker

# Génération du rapport
report:generate:
  stage: report
  image: python:3.11-slim
  before_script:
    # Fix horloge pour Python image aussi
    - echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until
    - apt-get update -qq
    - apt-get install -y -qq jq
    - pip3 install --quiet matplotlib pandas
  script:
    - cd scripts
    - python3 generate_dashboard.py ../results
  dependencies:
    - metrics:collect
  artifacts:
    paths:
      - results/
    expire_in: 3 months
  only:
    - main
  tags:
    - docker