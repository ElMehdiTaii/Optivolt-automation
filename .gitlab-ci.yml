# Configuration GitLab CI pour OptiVolt (Version avec Simulation)

stages:
  - build
  - deploy
  - test
  - metrics
  - report

variables:
  DOTNET_VERSION: "8.0"
  TEST_DURATION: "30"

.ssh_template: &ssh_template
  before_script:
    - echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until
    - apt-get update -qq
    - apt-get install -y -qq openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

build:cli:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - echo "=== Structure du d√©p√¥t ==="
    - pwd
    - ls -la
    - echo "=== Build du projet ==="
    - cd OptiVoltCLI
    - dotnet restore ./OptiVoltCLI.csproj
    - dotnet publish ./OptiVoltCLI.csproj -c Release -o ../publish
    - cd ..
    - echo "=== Copie des ressources ==="
    - test -d scripts && cp -r scripts publish/ || mkdir -p publish/scripts
    - test -d config && cp -r config publish/ || mkdir -p publish/config
    - echo "=== Contenu final ==="
    - ls -laR publish/
  artifacts:
    paths:
      - publish/
    expire_in: 1 hour
  tags: [docker]

# ‚úÖ D√©ploiement en mode simulation (sans SSH)
deploy:docker:
  stage: deploy
  image: mcr.microsoft.com/dotnet/sdk:8.0

  # üëá Add a Docker daemon only for this job
  services:
    - name: docker:27-dind
      alias: docker

  # üëá Limit Docker-in-Docker vars to this job
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_CERT_PATH: "/certs/client"
    DOCKER_TLS_VERIFY: "1"

  before_script:
    # Install Docker CLI in the .NET image (Debian/Ubuntu base)
    - echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until
    - apt-get update -qq
    - apt-get install -y -qq docker.io || apt-get install -y -qq docker-cli || true

    # Wait for docker:dind to be ready
    - |
      for i in $(seq 1 40); do
        docker info >/dev/null 2>&1 && break
        echo "Waiting for Docker daemon... ($i/40)"; sleep 1
      done
    - docker info

  script:
    - cd publish
    - echo "[CI/CD] D√©ploiement Docker"
    - chmod +x scripts/deploy_docker.sh
    # Optionnel: ne pas √©chouer si docker pas dispo (s√©curit√©)
    - command -v docker || { echo "[WARN] docker introuvable, on simule le d√©ploiement"; exit 0; }
    - bash scripts/deploy_docker.sh /tmp/optivolt-tests
    - echo "[CI/CD] ‚úì D√©ploiement termin√©"

  dependencies:
    - build:cli
  only:
    - main
    - develop
  tags:
    - docker

deploy:microvm:
  stage: deploy
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - cd publish
    - echo "[CI/CD] Simulation du d√©ploiement MicroVM"
    - chmod +x scripts/deploy_microvm.sh
    - bash scripts/deploy_microvm.sh /tmp/optivolt-tests
  dependencies:
    - build:cli
  only:
    - main
  when: manual
  tags:
    - docker

deploy:unikernel:
  stage: deploy
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - cd publish
    - echo "[CI/CD] Simulation du d√©ploiement Unikernel"
    - chmod +x scripts/deploy_unikernel.sh
    - bash scripts/deploy_unikernel.sh /tmp/optivolt-tests
  dependencies:
    - build:cli
  only:
    - main
  when: manual
  tags:
    - docker

# Tests simplifi√©s
test:cpu:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - cd publish
    - echo "[TEST] Simulation test CPU"
    - echo '{"test":"cpu","status":"passed"}' > ../results/test_cpu.json
    - mkdir -p ../results
    - echo "[TEST] ‚úì Test CPU termin√©"
  dependencies:
    - build:cli
    - deploy:docker
  artifacts:
    paths:
      - results/
    expire_in: 1 week
  tags:
    - docker

test:api:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - cd publish
    - echo "[TEST] Simulation test API"
    - mkdir -p ../results
    - echo '{"test":"api","status":"passed"}' > ../results/test_api.json
    - echo "[TEST] ‚úì Test API termin√©"
  dependencies:
    - build:cli
    - deploy:docker
  artifacts:
    paths:
      - results/
    expire_in: 1 week
  tags:
    - docker

test:db:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - cd publish
    - echo "[TEST] Simulation test DB"
    - mkdir -p ../results
    - echo '{"test":"db","status":"passed"}' > ../results/test_db.json
    - echo "[TEST] ‚úì Test DB termin√©"
  dependencies:
    - build:cli
    - deploy:docker
  artifacts:
    paths:
      - results/
    expire_in: 1 week
  tags:
    - docker

metrics:collect:
  stage: metrics
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - apt-get update -qq && apt-get install -y -qq jq || true
    - cd publish
    - echo "[METRICS] Simulation collecte de m√©triques"
    - mkdir -p ../results
    - |
      cat > ../results/docker_metrics_ci.json <<EOF
      {
        "metadata": {
          "environment": "docker",
          "timestamp": "$(date +%Y%m%d_%H%M%S)",
          "duration_seconds": 30,
          "hostname": "$(hostname)",
          "kernel": "$(uname -r)"
        },
        "system_metrics": {
          "averages": {
            "cpu_usage_percent": 45.2,
            "memory_usage_percent": 38.5
          }
        },
        "energy_metrics": {
          "note": "Simulated in CI/CD"
        },
        "container_metrics": {}
      }
      EOF
    - echo "[METRICS] ‚úì M√©triques simul√©es g√©n√©r√©es"
  dependencies:
    - build:cli
    - test:cpu
    - test:api
    - test:db
  artifacts:
    paths:
      - results/
    expire_in: 1 month
  tags:
    - docker

report:generate:
  stage: report
  image: python:3.11-slim
  before_script:
    - echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until
    - apt-get update -qq
    - apt-get install -y -qq jq || true
    - pip3 install --quiet matplotlib pandas || true
  script:
    - ls -la results/ || echo "Pas de r√©sultats"
    - echo "[REPORT] G√©n√©ration du dashboard (simulation)"
    - test -f publish/scripts/generate_dashboard.py && python3 publish/scripts/generate_dashboard.py results || echo "Dashboard generation skipped"
    - echo "[REPORT] ‚úì Rapport g√©n√©r√©"
  dependencies:
    - metrics:collect
    - build:cli
  artifacts:
    paths:
      - results/
    expire_in: 3 months
  only:
    - main
  tags:
    - docker