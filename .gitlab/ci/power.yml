# ==============================================================================
# POWER MONITORING STAGE
# Monitoring de la consommation électrique avec Scaphandre
# ==============================================================================

power:scaphandre-setup:
  stage: power-monitoring
  image: ubuntu:22.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq wget tar sudo
  script:
    - echo "⚡ [POWER] Vérification de l'environnement Scaphandre"
    - chmod +x scripts/setup_scaphandre.sh
    - echo "ℹ️  [POWER] Ce job vérifie seulement les prérequis (pas d'installation)"
    - ./scripts/setup_scaphandre.sh check || echo "✓ Vérification terminée - RAPL non disponible (normal dans Docker)"
    - echo "ℹ️  [POWER] Scaphandre sera installé dans le job suivant (power:collect-energy)"
    - echo "ℹ️  [POWER] Les métriques RAPL réelles nécessitent un runner bare-metal"
    - echo "✅ [POWER] Vérification terminée"
  allow_failure: true
  tags:
    - docker

power:collect-energy:
  stage: power-monitoring
  image: ubuntu:22.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq wget tar sudo jq python3 python3-pip
    - pip3 install --no-cache-dir psutil
  script:
    - echo "========================================="
    - echo "⚡ [POWER] Collecte énergie + workload"
    - echo "========================================="
    - mkdir -p results
    - chmod +x scripts/setup_scaphandre.sh
    - chmod +x scripts/workload_benchmark.py
    # Installation de Scaphandre
    - ./scripts/setup_scaphandre.sh install || echo "[POWER] Installation simulée"
    # Collecte des métriques de puissance
    - |
      if [ -d "/sys/class/powercap/intel-rapl" ] || [ -d "/sys/class/powercap/intel-rapl:0" ]; then
        echo "✓ RAPL disponible - Collecte réelle avec workload"
        ./scripts/setup_scaphandre.sh prometheus &
        SCAPHANDRE_PID=$!
        sleep 5
        WORKLOAD_DURATION=30 WORKLOAD_INTENSITY=heavy python3 scripts/workload_benchmark.py
        kill $SCAPHANDRE_PID 2>/dev/null || true
        ./scripts/setup_scaphandre.sh run results/scaphandre_power.json 10
      else
        echo "⚠️  RAPL non disponible - Collecte simulée"
        mkdir -p results
        TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
        echo "{\"available\":false,\"note\":\"RAPL not available in container\",\"timestamp\":\"$TIMESTAMP\"}" > results/scaphandre_power.json
      fi
    - echo "✅ [POWER] Métriques de consommation collectées"
    - ls -la results/
  artifacts:
    paths:
      - results/scaphandre_power.json
    expire_in: 1 month
  dependencies:
    - power:scaphandre-setup
  allow_failure: true
  tags:
    - docker
