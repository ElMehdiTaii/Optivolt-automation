# ==============================================================================
# DEPLOY STAGE
# D√©ploiement sur les diff√©rents environnements (Docker, MicroVM, Unikernel)
# ==============================================================================

deploy:docker:
  stage: deploy
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - cd publish
    - ls -la config/hosts.json
    - mkdir -p ../results
    - date -u +%Y-%m-%dT%H:%M:%SZ > ../results/timestamp.txt
    - echo '{"environment":"docker","status":"validated"}' > ../results/docker_deploy_results.json
    - cat ../results/docker_deploy_results.json
  dependencies:
    - build:cli
  artifacts:
    paths:
      - results/docker_deploy_results.json
    expire_in: 1 hour
  only:
    - main
    - develop
  allow_failure: false
  tags:
    - docker

deploy:microvm:
  stage: deploy
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - echo "üñ•Ô∏è  [DEPLOY] MicroVM - Mode Simulation (192.168.1.101)"
    - cd publish
    - echo "[DEPLOY] Configuration MicroVM:"
    - cat config/hosts.json | grep -A 6 '"microvm"' || echo "Config non trouv√©e"
    - echo "‚ÑπÔ∏è  Pour d√©ployer sur 192.168.1.101, ex√©cutez manuellement:"
    - echo "ssh optivolt@192.168.1.101 bash /home/optivolt/optivolt-tests/deploy_microvm.sh"
    - echo "‚úÖ [DEPLOY] MicroVM configuration valid√©e"
  dependencies:
    - build:cli
    - deploy:docker
  only:
    - main
  allow_failure: true
  tags:
    - docker

deploy:unikernel:
  stage: deploy
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - echo "üîÆ [DEPLOY] Unikernel - Mode Simulation (192.168.1.102)"
    - cd publish
    - echo "[DEPLOY] Configuration Unikernel:"
    - cat config/hosts.json | grep -A 6 '"unikernel"' || echo "Config non trouv√©e"
    - echo "‚ÑπÔ∏è  Pour d√©ployer sur 192.168.1.102, ex√©cutez manuellement:"
    - echo "ssh optivolt@192.168.1.102 bash /home/optivolt/optivolt-tests/deploy_unikernel.sh"
    - echo "‚úÖ [DEPLOY] Unikernel configuration valid√©e"
  dependencies:
    - build:cli
    - deploy:docker
  only:
    - main
  allow_failure: true
  tags:
    - docker
